{% extends "base.html" %}

{% block title %}{{ title }} - {{ app_name }}{% endblock %}

{% block extra_css %}
<style>
    .lineas-table input {
        border: none;
        background: transparent;
    }
    .lineas-table input:focus {
        outline: none;
        background: #fff;
        border: 1px solid #ced4da;
    }
    .lineas-table .currency-input {
        text-align: right;
    }
    .lineas-table tr:hover {
        background-color: #f8f9fa;
    }
    .cuenta-search {
        position: relative;
    }
    .cuenta-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        max-height: 200px;
        overflow-y: auto;
        display: none;
    }
    .cuenta-dropdown.show {
        display: block;
    }
    .cuenta-dropdown-item {
        padding: 0.5rem;
        cursor: pointer;
    }
    .cuenta-dropdown-item:hover {
        background-color: #e9ecef;
    }
    .totals-row td {
        font-weight: bold;
        background-color: #e9ecef;
    }
    .balance-ok {
        color: #198754;
    }
    .balance-error {
        color: #dc3545;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="bi bi-{% if asiento %}pencil{% else %}plus-circle{% endif %}"></i>
            {{ title }}
        </h5>
        {% if not asiento %}
        <span class="badge bg-secondary">Siguiente Nro: {{ siguiente_numero }}</span>
        {% else %}
        <span class="badge bg-primary">Asiento Nro: {{ asiento.numero }}</span>
        {% endif %}
    </div>
    <div class="card-body">
        <form method="POST" id="asientoForm">
            {{ form.hidden_tag() }}
            <input type="hidden" name="lineas" id="lineasJson">

            <!-- Header -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <label for="fecha" class="form-label">Fecha *</label>
                    {{ form.fecha(class="form-control") }}
                </div>
                <div class="col-md-6">
                    <label for="leyenda_global" class="form-label">Leyenda Global</label>
                    {{ form.leyenda_global(class="form-control", rows="1") }}
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div class="form-check mt-2">
                        {{ form.es_apertura(class="form-check-input") }}
                        <label class="form-check-label" for="es_apertura">Asiento de Apertura</label>
                    </div>
                </div>
            </div>

            <!-- Lines Grid -->
            <div class="table-responsive">
                <table class="table table-bordered lineas-table" id="lineasTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;">#</th>
                            <th style="width: 120px;">Cuenta</th>
                            <th>Nombre</th>
                            <th style="width: 130px;">Debe</th>
                            <th style="width: 130px;">Haber</th>
                            <th style="width: 200px;">Leyenda</th>
                            <th style="width: 50px;"></th>
                        </tr>
                    </thead>
                    <tbody id="lineasBody">
                        <!-- Lines will be added dynamically -->
                    </tbody>
                    <tfoot>
                        <tr class="totals-row">
                            <td colspan="3" class="text-end">TOTALES:</td>
                            <td class="text-end" id="totalDebe">0.00</td>
                            <td class="text-end" id="totalHaber">0.00</td>
                            <td>
                                <span id="balanceStatus" class="balance-ok">
                                    <i class="bi bi-check-circle"></i> Balanceado
                                </span>
                            </td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary" onclick="addLinea()">
                    <i class="bi bi-plus"></i> Agregar Linea
                </button>
            </div>

            <hr>

            <div class="d-flex justify-content-between">
                <a href="{{ url_for('asientos.index') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <div>
                    {% if asiento %}
                    <button type="button" class="btn btn-danger me-2" onclick="confirmarAnular()">
                        <i class="bi bi-x-circle"></i> Anular
                    </button>
                    {% endif %}
                    <button type="submit" class="btn btn-primary" id="btnGuardar">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Anular Modal -->
{% if asiento %}
<div class="modal fade" id="anularModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmar Anulacion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Esta seguro que desea anular el asiento <strong>{{ asiento.numero }}</strong>?</p>
                <p class="text-danger small">Esta accion revertira todos los saldos afectados.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="{{ url_for('asientos.anular', id=asiento.id) }}" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-danger">Anular Asiento</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
let lineaCount = 0;
let cuentasCache = {};

// Initialize with existing lines or empty rows
$(document).ready(function() {
    {% if lineas_existentes %}
    const lineasExistentes = {{ lineas_existentes | tojson }};
    lineasExistentes.forEach(function(linea) {
        addLinea(linea);
    });
    {% else %}
    // Add 5 empty rows by default
    for (let i = 0; i < 5; i++) {
        addLinea();
    }
    {% endif %}

    updateTotals();
});

function addLinea(data = null) {
    lineaCount++;
    const tbody = document.getElementById('lineasBody');
    const row = document.createElement('tr');
    row.id = 'linea-' + lineaCount;

    row.innerHTML = `
        <td class="text-center">${lineaCount}</td>
        <td class="cuenta-search">
            <input type="text" class="form-control form-control-sm cuenta-input"
                   data-linea="${lineaCount}"
                   value="${data ? data.cuenta_codigo : ''}"
                   placeholder="Cuenta..."
                   autocomplete="off">
            <input type="hidden" class="cuenta-id" value="${data ? data.cuenta_id : ''}">
            <div class="cuenta-dropdown"></div>
        </td>
        <td>
            <input type="text" class="form-control form-control-sm cuenta-nombre" readonly
                   value="${data ? data.cuenta_nombre : ''}" tabindex="-1">
        </td>
        <td>
            <input type="number" step="0.01" min="0"
                   class="form-control form-control-sm currency-input debe-input"
                   value="${data && data.debe ? data.debe.toFixed(2) : ''}"
                   onchange="updateTotals()">
        </td>
        <td>
            <input type="number" step="0.01" min="0"
                   class="form-control form-control-sm currency-input haber-input"
                   value="${data && data.haber ? data.haber.toFixed(2) : ''}"
                   onchange="updateTotals()">
        </td>
        <td>
            <input type="text" class="form-control form-control-sm leyenda-input" maxlength="50"
                   value="${data ? (data.leyenda || '') : ''}">
        </td>
        <td class="text-center">
            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeLinea(${lineaCount})">
                <i class="bi bi-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(row);

    // Setup account search
    setupCuentaSearch(row.querySelector('.cuenta-input'));
}

function removeLinea(num) {
    const row = document.getElementById('linea-' + num);
    if (row) {
        row.remove();
        updateTotals();
    }
}

function setupCuentaSearch(input) {
    const dropdown = input.parentElement.querySelector('.cuenta-dropdown');
    let searchTimeout;

    input.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        const query = this.value;

        if (query.length < 1) {
            dropdown.classList.remove('show');
            return;
        }

        searchTimeout = setTimeout(function() {
            fetch(`{{ url_for('cuentas.api_search') }}?q=${encodeURIComponent(query)}&imputable=true`)
                .then(response => response.json())
                .then(data => {
                    dropdown.innerHTML = '';
                    data.forEach(cuenta => {
                        const item = document.createElement('div');
                        item.className = 'cuenta-dropdown-item';
                        item.textContent = `${cuenta.cuenta} - ${cuenta.nombre}`;
                        item.onclick = function() {
                            selectCuenta(input, cuenta);
                        };
                        dropdown.appendChild(item);
                    });
                    dropdown.classList.add('show');
                });
        }, 200);
    });

    input.addEventListener('blur', function() {
        setTimeout(() => dropdown.classList.remove('show'), 200);
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Tab' && dropdown.classList.contains('show')) {
            const firstItem = dropdown.querySelector('.cuenta-dropdown-item');
            if (firstItem) {
                firstItem.click();
            }
        }
    });
}

function selectCuenta(input, cuenta) {
    const row = input.closest('tr');
    input.value = cuenta.cuenta;
    row.querySelector('.cuenta-id').value = cuenta.id;
    row.querySelector('.cuenta-nombre').value = cuenta.nombre;
    input.parentElement.querySelector('.cuenta-dropdown').classList.remove('show');

    // Focus on debe field
    row.querySelector('.debe-input').focus();
}

function updateTotals() {
    let totalDebe = 0;
    let totalHaber = 0;

    document.querySelectorAll('#lineasBody tr').forEach(row => {
        const debe = parseFloat(row.querySelector('.debe-input').value) || 0;
        const haber = parseFloat(row.querySelector('.haber-input').value) || 0;
        totalDebe += debe;
        totalHaber += haber;
    });

    document.getElementById('totalDebe').textContent = formatCurrency(totalDebe);
    document.getElementById('totalHaber').textContent = formatCurrency(totalHaber);

    const balanceStatus = document.getElementById('balanceStatus');
    const diff = Math.abs(totalDebe - totalHaber);

    if (diff < 0.01 && totalDebe > 0) {
        balanceStatus.className = 'balance-ok';
        balanceStatus.innerHTML = '<i class="bi bi-check-circle"></i> Balanceado';
    } else {
        balanceStatus.className = 'balance-error';
        balanceStatus.innerHTML = `<i class="bi bi-exclamation-circle"></i> Diferencia: ${formatCurrency(diff)}`;
    }
}

// Form submission
document.getElementById('asientoForm').addEventListener('submit', function(e) {
    e.preventDefault();

    const lineas = [];
    let hasError = false;

    document.querySelectorAll('#lineasBody tr').forEach(row => {
        const cuentaId = row.querySelector('.cuenta-id').value;
        const debe = parseFloat(row.querySelector('.debe-input').value) || 0;
        const haber = parseFloat(row.querySelector('.haber-input').value) || 0;
        const leyenda = row.querySelector('.leyenda-input').value;

        // Only include rows with account and amount
        if (cuentaId && (debe > 0 || haber > 0)) {
            lineas.push({
                cuenta_id: parseInt(cuentaId),
                debe: debe,
                haber: haber,
                leyenda: leyenda
            });
        }
    });

    if (lineas.length === 0) {
        alert('El asiento debe tener al menos una linea con cuenta e importe.');
        return;
    }

    // Check balance
    const totalDebe = lineas.reduce((sum, l) => sum + l.debe, 0);
    const totalHaber = lineas.reduce((sum, l) => sum + l.haber, 0);

    if (Math.abs(totalDebe - totalHaber) > 0.01) {
        alert('El asiento no esta balanceado. Debe = Haber.');
        return;
    }

    document.getElementById('lineasJson').value = JSON.stringify(lineas);
    this.submit();
});

function confirmarAnular() {
    new bootstrap.Modal(document.getElementById('anularModal')).show();
}
</script>
{% endblock %}
